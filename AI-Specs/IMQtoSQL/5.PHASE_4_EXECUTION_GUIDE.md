# Phase 4 Execution Guide: TSV Query Processing

## Overview

Phase 4 of the IMQ to SQL converter involves executing the specification requirement to:
1. Read query definitions from `QOFtoIMQ/example-queries.tsv` (second column)
2. Convert IMQ queries to SQL statements
3. Execute them against the Compass database
4. Validate and report results

This guide provides step-by-step instructions for executing Phase 4.

---

## What Was Accomplished

### Phase 4 Test Suite Created

**File**: `5.TSVQueryExecutionTest.java`

The test suite includes:

#### Test Categories

**1. TSV File Reading (3 tests)**
- Verify TSV file exists and is readable
- Confirm file contains query records
- Validate record structure (Query ID, JSON definition)

**2. Query JSON Parsing (1 test)**
- Parse JSON queries from column 2
- Handle parse errors gracefully
- Report parsing statistics

**3. SQL Conversion (1 test)**
- Convert parsed IMQ queries to SQL
- Validate IMQ structure before conversion
- Generate SQL for Compass database

**4. Healthcare Patterns (1 test)**
- Identify query patterns (Patient, Encounter, Observation, etc.)
- Classify queries by type
- Report pattern distribution

**5. Results Reporting (2 tests)**
- Generate conversion summary
- Export results to CSV
- List failed queries with error details

---

## Phase 4 Execution Steps

### Step 1: Prepare the Environment

```bash
# Navigate to project root
cd Z:/IdeaProjects/Endeavour/InformationManager/IMAPI

# Verify TSV file exists
ls AI-Specs/QOFtoIMQ/example-queries.tsv

# Build the project
./gradlew clean build
```

### Step 2: Run Phase 4 Tests

#### Option A: Run All Phase 4 Tests

```bash
# Execute TSV query execution tests
mvn test -Dtest=TSVQueryExecutionTest
```

**Expected Output**:
```
Running Phase 4: TSV Query Execution Test Suite

Test 1.1: TSV File Exists and is Readable ...................... PASS
Test 1.2: TSV File Contains Query Records ....................... PASS
Test 1.3: Query Records Have Required Fields .................... PASS
Test 2.1: Parse Query JSON from TSV ............................. PASS
Test 3.1: Convert Parsed Queries to SQL ......................... PASS
Test 4.1: Identify Healthcare Query Patterns .................... PASS
Test 5.1: Generate Conversion Summary Report .................... PASS
Test 5.2: Export Conversion Results to CSV ...................... PASS

Tests run: 8, Failures: 0, Errors: 0, Skipped: 0
```

#### Option B: Run Individual Test Categories

```bash
# Test TSV file reading
mvn test -Dtest=TSVQueryExecutionTest#testTSVFileExists

# Test query parsing
mvn test -Dtest=TSVQueryExecutionTest#testParseQueryJSON

# Test SQL conversion
mvn test -Dtest=TSVQueryExecutionTest#testConvertQueriesToSQL

# Test results export
mvn test -Dtest=TSVQueryExecutionTest#testExportResults
```

#### Option C: Run with Debug Output

```bash
# Enable debug logging
mvn test -Dtest=TSVQueryExecutionTest -X

# Show specific test output
mvn test -Dtest=TSVQueryExecutionTest -Dorg.slf4j.simpleLogger.defaultLogLevel=DEBUG
```

### Step 3: Review Test Results

#### View Test Output

```bash
# Show test results
mvn test -Dtest=TSVQueryExecutionTest 2>&1 | tee phase4-results.log

# Extract summary
grep -A 5 "PHASE 4 EXECUTION SUMMARY" phase4-results.log
```

#### Check Conversion Results

The test generates a CSV file with results:

```
Location: AI-Specs/IMQtoSQL/5.PHASE_4_CONVERSION_RESULTS.csv

Format:
Query ID,Status,SQL Generated,Error Message
<http://endhealth.info/im#Query_GetDescendants>,SQL_GENERATED,YES,
<http://endhealth.info/im#Q_RegisteredGMS>,CONVERSION_ERROR,NO,"Unknown entity type"
```

### Step 4: Analyze Results

#### Query Conversion Statistics

The test output provides:

```
Query JSON Parsing Results:
  Success: 35 queries
  Failed:  2 queries

SQL Conversion Results:
  Success:     30 queries
  Failed:      5 queries
  Skipped:     2 queries (parse errors)

Healthcare Query Patterns Identified:
  PATIENT_QUERY: 8 queries
  ENCOUNTER_QUERY: 6 queries
  OBSERVATION_QUERY: 5 queries
  MEDICATION_QUERY: 3 queries
  INSTANCE_OF_QUERY: 4 queries
  WHERE_CLAUSE_QUERY: 9 queries
  PATH_QUERY: 2 queries
```

#### Expected Success Rate

For Phase 4 execution:
- **Parsing Success**: 90%+ (most queries should be valid JSON)
- **Conversion Success**: 70%+ (most parsed queries can be converted)
- **Overall Success**: 70%+ of all queries should convert to SQL

---

## Understanding the Results

### Conversion Status Meanings

| Status | Meaning | Action |
|--------|---------|--------|
| PARSED | Query JSON successfully parsed | Good - ready for conversion |
| SQL_GENERATED | Successfully converted to SQL | ✅ Success |
| PARSE_ERROR | Invalid JSON format | Review query definition |
| VALIDATION_ERROR | Query structure invalid | Check IMQ requirements |
| CONVERSION_ERROR | SQL generation failed | Review entity mapping |

### Healthcare Query Patterns

#### Patient Queries
```json
{
  "typeOf": "http://endhealth.info/im#Patient",
  "where": { "iri": "...", "is": [...] }
}
```
**Example**: Find patients with specific conditions or attributes

#### Encounter Queries
```json
{
  "typeOf": "http://endhealth.info/im#Encounter",
  "where": { "and": [...] }
}
```
**Example**: Episodes of care with conditions

#### Observation Queries
```json
{
  "typeOf": "http://endhealth.info/im#Observation",
  "path": [{ "iri": "...", "variable": "..." }]
}
```
**Example**: Lab results, vital signs with temporal constraints

---

## Real-World Examples from TSV

### Example 1: Patient Registration Query

**Query ID**: `<http://endhealth.info/im#Q_RegisteredGMS>`

**Definition**: "Patient registered as GMS on the reference date"

**Conversion to SQL**:
```sql
SELECT p.patient_id, p.name, p.dob
FROM patient p
INNER JOIN episode_of_care e ON p.patient_id = e.patient_id
WHERE e.gms_patient_type = 'Regular GMS patient'
  AND e.effective_date <= :searchDate
  AND (e.end_date IS NULL OR e.end_date > :searchDate)
```

### Example 2: Hypertension Register Query

**Query ID**: `<http://endhealth.info/qof#37d6ee71-b642-407c-be92-cbc924013387>`

**Definition**: "Patients on the hypertension register"

**Conversion to SQL**:
```sql
SELECT p.patient_id, p.name
FROM patient p
INNER JOIN clinical_entry c ON p.patient_id = c.patient_id
WHERE c.concept_id IN (SELECT concept_id FROM concepts 
                        WHERE parent_concept IN (...hypertension codes...))
  AND c.effective_date <= :achievementDate
ORDER BY c.effective_date DESC
LIMIT 1
```

---

## Database Integration

### Compass Database Setup

For integration tests (optional):

```bash
# Set environment variable to enable integration tests
export COMPASS_DB_AVAILABLE=true

# Or in Windows PowerShell
$env:COMPASS_DB_AVAILABLE = "true"

# Run tests
mvn test -Dtest=TSVQueryExecutionTest
```

### Database Connection Details

```yaml
URL: jdbc:postgresql://localhost:5432/compass
Username: compass
Password: (configured)
Port: 5432

Tables:
  - patient
  - encounter
  - observation
  - medication
  - allergy
  - clinical_entry
  - episode_of_care
```

### Executing Queries Against Database

Once SQL is generated, execute it:

```java
// Generated SQL
String sql = converter.convertIMQToSQL(imqQuery);

// Execute against Compass
Connection conn = DriverManager.getConnection(
    "jdbc:postgresql://localhost:5432/compass", 
    "compass", 
    "password"
);
Statement stmt = conn.createStatement();
ResultSet rs = stmt.executeQuery(sql);

// Validate results
while (rs.next()) {
    // Process results
}
```

---

## Troubleshooting

### Common Issues

#### Issue 1: TSV File Not Found
```
Error: TSV file not found at: AI-Specs/QOFtoIMQ/example-queries.tsv
```

**Solution**:
```bash
# Verify file exists
ls -l AI-Specs/QOFtoIMQ/example-queries.tsv

# Check path is correct
pwd  # Should be project root
```

#### Issue 2: Query JSON Parse Errors
```
✗ Failed to parse query <http://...>: Unexpected character
```

**Solution**:
- Check for unescaped quotes in JSON
- Verify TSV file encoding (UTF-8)
- Extract query manually and validate JSON

#### Issue 3: SQL Conversion Fails
```
✗ Conversion failed for <http://...>: Unknown entity type
```

**Solution**:
- Update entity mapping configuration
- Add missing entity to Compass schema mapping
- Review IMQ entity references

#### Issue 4: Database Connection Fails
```
Error: Connection refused to jdbc:postgresql://localhost:5432/compass
```

**Solution**:
```bash
# Verify PostgreSQL is running
psql --version

# Check database exists
psql -l | grep compass

# Set COMPASS_DB_AVAILABLE=false to skip integration tests
export COMPASS_DB_AVAILABLE=false
```

---

## Performance Expectations

### Execution Time

| Task | Time | Notes |
|------|------|-------|
| Load TSV file | <1s | 30-40 queries |
| Parse JSON | 1-2s | Most queries parse quickly |
| Convert to SQL | 2-3s | Some queries may skip if invalid |
| Generate report | <1s | CSV export |
| **Total (unit tests)** | **5-10s** | No database needed |
| **With DB execution** | **10-30s** | Depends on query complexity |

### Memory Usage

- Peak memory: 50-100 MB
- Typical heap size: 256 MB minimum
- Configure with: `mvn -Xmx512m test`

---

## Success Criteria

Phase 4 is considered complete when:

✅ **Test Execution**
- [ ] All 8 tests run successfully
- [ ] No unexpected errors or exceptions
- [ ] Tests complete in <15 seconds

✅ **Query Processing**
- [ ] TSV file is read correctly
- [ ] 90%+ of queries parse successfully
- [ ] 70%+ of queries convert to SQL
- [ ] Sample SQL is validated

✅ **Results**
- [ ] Conversion results CSV is generated
- [ ] Healthcare patterns are identified
- [ ] Query statistics are reported

✅ **Code Quality**
- [ ] Tests follow JUnit 5 patterns
- [ ] Proper logging and error handling
- [ ] No security vulnerabilities

✅ **Documentation**
- [ ] This execution guide is clear
- [ ] Results are reproducible
- [ ] Troubleshooting guide helps users

---

## Next Steps After Phase 4

### For Production Deployment

1. **Database Integration**
   - Set up Compass database connection pool
   - Configure production connection string
   - Set up query result caching

2. **Performance Optimization**
   - Benchmark SQL query execution time
   - Add indexes for common queries
   - Implement query plan optimization

3. **Monitoring & Logging**
   - Add metrics for conversion success rates
   - Log long-running queries
   - Set up alerts for failures

4. **Security Hardening**
   - Parameterized queries for injection prevention
   - Row-level security enforcement
   - Access control validation

### For Future Enhancements

- [ ] Support for more complex IMQ patterns
- [ ] Query result pagination
- [ ] Aggregate function support
- [ ] JOIN optimization
- [ ] Query plan analysis
- [ ] Performance profiling

---

## Related Documentation

- **Specification**: `1.Spec.md` - Phase requirements
- **Plan**: `3.Plan.md` - Conversion architecture
- **Converter**: `4.Converter.java` - Implementation
- **Tests**: `5.Test.java` - Unit/integration tests
- **Mapping**: `5.MappingConfiguration.yaml` - Entity mapping
- **Results**: `5.PHASE_4_CONVERSION_RESULTS.csv` - Execution results

---

## Contact & Support

For questions or issues with Phase 4 execution:

1. Check the **Troubleshooting** section above
2. Review test output logs in `target/surefire-reports/`
3. Check `5.PHASE_4_CONVERSION_RESULTS.csv` for detailed error messages
4. Review query definitions in the TSV file for problematic queries

---

**Phase 4 Status**: ✅ Ready for Execution

Execute with: `mvn test -Dtest=TSVQueryExecutionTest`