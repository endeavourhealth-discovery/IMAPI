@prefix rr: <http://www.w3.org/ns/r2rml#>.
@prefix rml: <http://semweb.mmlab.be/ns/rml#>.
@prefix ql: <http://semweb.mmlab.be/ns/ql#>.
@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.
@prefix im: <http://endhealth.info/im#>.
@prefix fno:     <https://w3id.org/function/ontology#> .
@prefix foaf:    <http://xmlns.com/foaf/0.1/> .
@prefix grel:    <http://users.ugent.be/~bjdmeest/function/grel.ttl#> .
@prefix fnml:     <http://semweb.mmlab.be/ns/fnml#> .
@base <http://localhost:8080/api/mapping/prsb.ttl#>.

<#Prsb> a rr:TriplesMap;
  rml:logicalSource [
    rml:source "RetrieveTransaction.json" ;
    rml:referenceFormulation ql:JSONPath;
    rml:iterator "$.dataset[*].concept[*].concept[*]"
  ];

  rr:subjectMap [
    # rr:template "http://endhealth.info/ref#{id}";
    fnml:functionValue [
        rr:predicateObjectMap [
          rr:predicate fno:executes ;
          rr:objectMap [ rr:constant im:generateIri ] 
        ] ;
        rr:predicateObjectMap [
          rr:predicate im:valueParameter ;
          rr:objectMap [ rr:template "{name[0]['#text']}" ] 
        ]
      ];
    rr:class im:Prsb
  ];

  rr:predicateObjectMap [
    rr:predicate im:subtype;
    rr:objectMap [
      rr:template "http://endhealth.info/ref#{concept[*].id}";
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate im:label;
    rr:objectMap [
      rml:reference "name[0]['#text']"
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate im:comment;
    rr:objectMap [
      rml:reference "desc[0]['#text']"
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate im:shortName;
    rr:objectMap [
      rml:reference "shortName"
    ]
  ];

  rr:predicateObjectMap [
    rr:predicate im:code;
    rr:objectMap [
      rml:reference "iddisplay"
    ]
  ];

 rr:predicateObjectMap [
   rr:predicate im:parent;
   rr:objectMap [
     rr:parentTriplesMap <#Parent>;
     rr:joinCondition [
       rr:child "id";
       rr:parent "concept[*].id";
     ];
   ];
 ].

 <#Parent> a rr:TriplesMap;
   rml:logicalSource [
     rml:source "RetrieveTransaction.json" ;
     rml:referenceFormulation ql:JSONPath;
     rml:iterator "$.dataset[*].concept[*]";
   ];
   rr:subjectMap [
    # rr:template "http://endhealth.info/ref#{id}";
    fnml:functionValue [
        rr:predicateObjectMap [
          rr:predicate fno:executes ;
          rr:objectMap [ rr:constant im:generateIri ] 
        ] ;
        rr:predicateObjectMap [
          rr:predicate im:valueParameter ;
          rr:objectMap [ rr:template "{name[0]['#text']}" ] 
        ]
    ];
  ].