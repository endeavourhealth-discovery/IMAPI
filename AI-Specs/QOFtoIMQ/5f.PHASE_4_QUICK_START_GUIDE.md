# Phase 4 Quick Start Guide

Get up and running with QOF-to-IMQuery transformation in minutes.

## Installation

No installation required! The transformation engine is built into the IMAPI project.

## Running the Demonstrator

The easiest way to see Phase 4 in action:

```bash
cd Z:\IdeaProjects\Endeavour\InformationManager\IMAPI
./gradlew build
java -cp build/libs/imapi.jar org.endeavourhealth.imapi.transformation.example.Phase4Demonstrator
```

This will:
1. Create a sample QOF document
2. Transform it to IMQuery
3. Generate 3-5 query files
4. Display transformation statistics

## Using from Command Line

### Transform a Single File

```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input QOF-Diabetes.json \
  --output ./queries
```

### Transform a Directory

```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-files \
  --output ./queries \
  --format batch
```

### Verbose Output

```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input QOF-Diabetes.json \
  --output ./queries \
  --verbose
```

### Single Combined Output File

```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-files \
  --output ./queries \
  --format single
```

## Using Programmatically

### Basic Usage

```java
import org.endeavourhealth.imapi.model.qof.QOFDocument;
import org.endeavourhealth.imapi.model.imq.Query;
import org.endeavourhealth.imapi.transformation.engine.QOFToIMQTransformer;
import org.endeavourhealth.imapi.transformation.output.QOFDocumentLoader;
import org.endeavourhealth.imapi.transformation.output.QueryOutputWriter;

// Load QOF document
QOFDocument qofDoc = QOFDocumentLoader.loadFromFile("QOF-Diabetes.json");

// Create transformer
QOFToIMQTransformer transformer = new QOFToIMQTransformer();

// Transform
Map<String, Query> queries = transformer.transform(qofDoc);

// Write output
QueryOutputWriter.writeQueries(
  queries, 
  "./output", 
  QueryOutputWriter.OverwriteStrategy.ALLOW
);

// Get specific query
Query diabetesRegister = queries.get("DM_REG");
System.out.println(diabetesRegister.getName());
System.out.println(diabetesRegister.getDescription());
```

### With Error Handling

```java
try {
  Map<String, Query> queries = transformer.transform(qofDoc);
  
  // Check for any issues
  for (Query query : queries.values()) {
    if (query.getIri() == null) {
      System.err.println("Query " + query.getName() + " has no IRI");
    }
  }
  
  QueryOutputWriter.writeQueries(queries, "./output", 
    QueryOutputWriter.OverwriteStrategy.ALLOW);
  
} catch (Exception e) {
  System.err.println("Transformation failed: " + e.getMessage());
  e.printStackTrace();
}
```

### Custom Field Mapping

```java
// Access field mapping
FieldMappingDictionary fieldMapping = transformer.getFieldMapping();

// Register custom mapping
fieldMapping.registerMapping("CUSTOM_FIELD", 
  "http://custom.namespace/field");

// Now transformation will use custom mapping
Map<String, Query> queries = transformer.transform(qofDoc);
```

### Batch Processing

```java
import java.nio.file.Files;
import java.nio.file.Paths;

// Load multiple files
List<QOFDocument> documents = QOFDocumentLoader
  .loadFromDirectory("./qof-files");

// Transform all
Map<String, Query> allQueries = new LinkedHashMap<>();
for (QOFDocument doc : documents) {
  allQueries.putAll(transformer.transform(doc));
}

// Write combined output
QueryOutputWriter.writeQueriesCombined(
  allQueries, 
  "./all-queries.json", 
  QueryOutputWriter.OverwriteStrategy.ALLOW
);
```

## Example: Diabetes QOF

Given this QOF input:

```json
{
  "name": "Diabetes_v49.0",
  "selections": [{
    "name": "GMS registration status",
    "rules": [{
      "logic": "(If REG_DAT ≠ Null AND If DEREG_DAT = Null)",
      "ifTrue": "Select",
      "ifFalse": "Reject",
      "description": "Select registered patients"
    }]
  }],
  "registers": [{
    "name": "DM_REG",
    "description": "Diabetes register",
    "base": "GMS registration status",
    "rules": [{
      "rule": 1,
      "logic": "If PAT_AGE < 17 years",
      "ifTrue": "Reject",
      "ifFalse": "Select"
    }]
  }]
}
```

Transformation produces:

```json
{
  "iri": "http://endhealth.info/qof#selection-gms-registration-status",
  "name": "GMS registration status",
  "description": "Cohort query for selection: GMS registration status",
  "typeOf": {
    "iri": "http://endhealth.info/im#Patient"
  },
  "rule": [{
    "ifTrue": "SELECT",
    "ifFalse": "REJECT",
    "where": {
      "iri": "http://endhealth.info/im#Patient.registrationDate",
      "operator": "not_null"
    }
  }],
  "prefixes": {...}
}
```

## Supported QOF Logic Patterns

### Null Checks
```
If FIELD = Null           → FIELD IS NULL
If FIELD ≠ Null           → FIELD IS NOT NULL
```

### Comparisons
```
If AGE < 17 years         → AGE < 17
If DATE > ACHV_DAT        → DATE > ACHIEVEMENT_DATE
If VALUE = 100            → VALUE = 100
```

### Logical Operators
```
CONDITION1 AND CONDITION2 → Both must be true
CONDITION1 OR CONDITION2  → At least one must be true
```

### Complex Expressions
```
(If REG_DAT ≠ Null AND If DEREG_DAT = Null)
  OR
(If REG_DAT ≠ Null AND If DEREG_DAT > ACHV_DAT)
```

## Configuration

Create a `transformation.yaml` config file:

```yaml
fieldMappings:
  CUSTOM_FIELD: "http://custom.iri#field"
  ANOTHER_FIELD: "http://other.iri#field"

prefixes:
  custom: "http://custom.namespace#"
  other: "http://other.namespace#"

outputOptions:
  prettyPrint: true
  includeNulls: false
  overwriteFiles: true
```

Load in Java:
```java
ConfigurationLoader config = ConfigurationLoader.fromFile("transformation.yaml");
// Apply config to transformer...
```

## Common Tasks

### Transform All Files in a Directory
```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-specifications \
  --output ./generated-queries \
  --verbose
```

### Create Single Combined File
```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-specifications \
  --output ./queries.json \
  --format single
```

### Backup Existing Files
```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-specifications \
  --output ./generated-queries \
  --overwrite backup
```

### Prevent Overwriting
```bash
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input ./qof-specifications \
  --output ./new-queries \
  --overwrite deny
```

## Troubleshooting

### "QOF file not found"
```
ERROR: QOF file not found: QOF-Diabetes.json
→ Check file path and ensure file exists
```

### "Unknown field in logic"
```
WARNING: Field reference not found: CUSTOM_FIELD
→ Register field mapping or update QOF specification
```

### "Invalid transformation"
```
ERROR: Register 'DM_REG' has no base Selection
→ Ensure Register references a valid Selection
```

### "File already exists"
```
ERROR: File already exists: ./queries/output.json
→ Use --overwrite backup or --overwrite allow
```

## Performance Tips

1. **Batch Processing**: Transform multiple files at once
2. **Single Output**: Use `--format single` for faster I/O
3. **Disable Validation**: Set validation level to minimal for large batches
4. **Parallel Processing**: Distribute large batches across machines

## Next Steps

1. **Review Generated Queries**: Check output JSON files
2. **Validate Against Database**: Test queries against your data model
3. **Customize Field Mapping**: Add your organization's field mappings
4. **Integrate into Workflow**: Use in your data pipeline
5. **Monitor Performance**: Log and analyze transformation metrics

## Documentation

For more details, see:
- **PHASE_4_IMPLEMENTATION_GUIDE.md** - Comprehensive implementation details
- **QOF-To-IMQ-Specification.md** - Specification for transformation rules
- **QOF-Specification.md** - QOF format specification
- **IMQ-Specification.md** - IMQuery format specification

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Run with `--verbose` for detailed output
3. Review the implementation guide
4. Check log files in the output directory

## Version Information

- Phase 4 Version: 1.0
- Release Date: 2025
- Java Version: Java 21+
- Dependencies: Jackson, Lombok (included in IMAPI)

Enjoy transforming your QOF specifications!