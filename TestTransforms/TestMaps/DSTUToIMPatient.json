{
  "@id" : "http://endhealth.info/map#FHIR_2_PatientToIM",
  "source" : {
    "@id" : "http://hl7.org/2-0/fhir/StructureDefinition#Patient",
    "variable" : "fhirPatient"
  },
  "rules" : [ {
    "create" : {
      "@id" : "http://endhealth.info/im#Patient",
      "variable" : "imPatient"
    }
  }, {
    "sourceProperty" : "id",
    "sourceVariable" : "fhirId",
    "function" : {
      "@id" : "http://endhealth.info/im#Concatenate",
      "argument" : [ {
        "valueData" : "urn:uuid:"
      }, {
        "valueVariable" : "fhirId"
      } ]
    },
    "targetProperty" : "@id",
    "targetVariable" : "imId"
  }, {
    "sourceProperty" : "identifier",
    "flatMap" : {
      "rules" : [ {
        "sourceProperty" : "value",
        "sourceVariable" : "fhirNhsNumber",
        "where" : {
          "path" : "system",
          "value" : {
            "value" : "http://fhir.nhs.net/Id/nhs-number"
          }
        },
        "targetProperty" : "nhsNumber"
      } ]
    }
  }, {
    "sourceProperty" : "name",
    "sourceVariable" : "fhirName",
    "flatMap" : {
      "rules" : [ {
        "sourceProperty" : "family",
        "targetProperty" : "familyName"
      }, {
        "sourceProperty" : "given",
        "listMode" : "FIRST",
        "targetProperty" : "callingName"
      }, {
        "sourceProperty" : "given",
        "sourceVariable" : "fhirGiven",
        "listMode" : "ALL",
        "function" : {
          "@id" : "http://endhealth.info/im#StringJoin",
          "argument" : [ {
            "parameter" : "delimiter",
            "valueData" : " "
          }, {
            "parameter" : "elements",
            "valueVariable" : "fhirGiven"
          } ]
        },
        "targetProperty" : "forenames"
      } ]
    }
  }, {
    "sourceProperty" : "address",
    "targetProperty" : "homeAddress",
    "valueMap" : {
      "rules" : [ {
        "create" : {
          "@id" : "http://endhealth.info/im#Address"
        },
        "where" : {
          "path" : "use",
          "value" : {
            "value" : "home"
          }
        }
      }, {
        "sourceProperty" : "line",
        "targetProperty" : "addressLine"
      }, {
        "sourceProperty" : "postalCode",
        "targetProperty" : "postCode"
      }, {
        "sourceProperty" : "city",
        "targetProperty" : "addressLine",
        "targetUpdateMode" : "ADDTOLIST"
      } ]
    }
  }, {
    "sourceProperty" : "telecom",
    "flatMap" : {
      "rules" : [ {
        "sourceProperty" : "value",
        "where" : {
          "and" : [ {
            "path" : "system",
            "value" : {
              "value" : "phone"
            }
          }, {
            "path" : "use",
            "value" : {
              "value" : "mobile"
            }
          } ]
        },
        "targetProperty" : "mobileTelephoneNumber"
      } ]
    }
  }, {
    "sourceProperty" : "telecom",
    "flatMap" : {
      "rules" : [ {
        "sourceProperty" : "value",
        "where" : {
          "and" : [ {
            "path" : "system",
            "value" : {
              "value" : "phone"
            }
          }, {
            "path" : "use",
            "value" : {
              "value" : "home"
            }
          } ]
        },
        "targetProperty" : "homeTelephoneNumber"
      } ]
    }
  } ]
}