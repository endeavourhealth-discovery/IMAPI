# Phase 4: Test Execution Guide

## Overview

This guide explains how to run the comprehensive test suite for the IMQ to SQL converter (Phase 4). The test suite includes unit tests, integration tests, and edge case tests.

**Test File**: `5.Test.java` (in `org.endeavourhealth.imapi.transforms.compass` package)  
**Dependencies**: JUnit 5.10.1, Mockito 5.14.2, PostgreSQL Driver 42.7.4

---

## Test Structure

### Test Categories

#### 1. **Unit Tests** (No Database Required)
- Query validation and parsing
- SQL generation from IMQ queries  
- Entity mapping and resolution
- Condition translation (WHERE, AND, OR, NOT)
- Error handling
- Edge cases

**Tests**: 1.1-1.3, 2.1-2.10, 4.1-4.5  
**Runtime**: ~5-10 seconds per test run

#### 2. **Integration Tests** (Requires Compass Database)
- Database connection validation
- Query execution against real Compass database
- Result structure validation
- Organization filtering verification

**Tests**: 3.1-3.6  
**Runtime**: Depends on database performance  
**Prerequisites**: PostgreSQL running with Compass schema

---

## Running Tests

### Quick Start

```bash
# Run all unit tests (no database required)
mvn clean test -Dtest=IMQtoSQLConverterTest -DfailIfNoTests=false

# Run specific test class
mvn test -Dtest=IMQtoSQLConverterTest

# Run specific test method
mvn test -Dtest=IMQtoSQLConverterTest#testSimplePatientQueryConversion

# Run with detailed output
mvn test -Dtest=IMQtoSQLConverterTest -X

# Generate code coverage report
mvn clean test jacoco:report
```

### Running Unit Tests Only (Recommended for CI/CD)

```bash
# Exclude integration tests (those marked with @EnabledIfEnvironmentVariable)
mvn test -Dtest=IMQtoSQLConverterTest -DargLine="-Denv=test"

# Or in your build pipeline, set:
export COMPASS_DB_AVAILABLE=false
mvn test
```

### Running Integration Tests

#### Prerequisites

1. **PostgreSQL Service**: Must be running and accessible
2. **Compass Database**: Must be deployed to `localhost:5432`
3. **Credentials**: Set environment variables:
   ```bash
   export COMPASS_DB_URL="jdbc:postgresql://localhost:5432/compass"
   export COMPASS_DB_USER="compass"
   export COMPASS_DB_PASSWORD="your_password"
   export COMPASS_DB_AVAILABLE=true
   ```

#### Running Integration Tests

```bash
# Ensure environment variables are set, then:
export COMPASS_DB_AVAILABLE=true
mvn clean test -Dtest=IMQtoSQLConverterTest

# Run only integration tests
mvn clean test -Dtest=IMQtoSQLConverterTest -Dgroups="integration"

# Run with Docker Compose (if available)
docker-compose up -d compass-db
mvn test
docker-compose down
```

---

## Test Execution Flow

### Standard Test Flow

```
1. @BeforeEach: Initialize converter and configuration
   ↓
2. Test Category 1: Query Validation (Tests 1.1-1.3)
   - Validate basic query structure
   - Check for null/empty queries
   ↓
3. Test Category 2: Query Conversion (Tests 2.1-2.10)
   - Generate SQL from various IMQ patterns
   - Verify SQL correctness
   ↓
4. Test Category 3: Database Integration (Tests 3.1-3.6)
   - Only runs if COMPASS_DB_AVAILABLE=true
   - Execute actual SQL queries
   ↓
5. Test Category 4: Error Handling (Tests 4.1-4.5)
   - Validate error conditions
   - Test edge cases
   ↓
6. Test Result: Pass/Fail report
```

---

## Test Descriptions & Expected Results

### Category 1: Validation Tests (1.1-1.3)

| Test ID | Name | Input | Expected Result | Duration |
|---------|------|-------|-----------------|----------|
| 1.1 | Patient Query Validation | Valid Patient query | Valid result (no errors) | <100ms |
| 1.2 | Empty Query Validation | Query with no components | Invalid result (error message) | <100ms |
| 1.3 | Null Query Validation | null Query object | Invalid result (error message) | <100ms |

### Category 2: Conversion Tests (2.1-2.10)

| Test ID | Name | Query Type | Key Features | Expected SQL Contains | Duration |
|---------|------|-----------|--------------|----------------------|----------|
| 2.1 | Simple Patient Query | Patient | Basic structure | SELECT, FROM, WHERE | <200ms |
| 2.2 | Date Condition | Patient + Date | DOB comparison | date_of_birth, < | <200ms |
| 2.3 | Multiple AND Conditions | Patient | Compound WHERE | AND, status | <200ms |
| 2.4 | OR Conditions | Encounter | Alternative options | OR, encounter_type | <200ms |
| 2.5 | Concept Filtering | Observation | Concept IRI lookup | observation, concept | <200ms |
| 2.6 | Date Range | Medication | Temporal bounds | medication, start_date | <200ms |
| 2.7 | Patient Context | Encounter | Patient-specific | patient_id | <200ms |
| 2.8 | NOT Conditions | Patient | Negation logic | NOT, != | <200ms |
| 2.9 | Allergy Severity | Allergy | Domain-specific | allergy, severity | <200ms |
| 2.10 | Appointment Status | Appointment | Status filtering | appointment, status | <200ms |

### Category 3: Integration Tests (3.1-3.6)

| Test ID | Name | Prerequisites | Test Action | Success Criteria |
|---------|------|---------------|-------------|------------------|
| 3.1 | DB Connection | Compass running | Connect to DB | Connection established |
| 3.2 | Patient Query | DB available | Execute query | Result set valid |
| 3.3 | Encounter Query | DB available | Execute query | Result set valid |
| 3.4 | Observation Query | DB available | Execute query | Result set valid |
| 3.5 | Result Structure | DB available | Execute + analyze | Columns valid |
| 3.6 | Org Filtering | DB available | Verify WHERE clause | Org ID present |

### Category 4: Error Handling Tests (4.1-4.5)

| Test ID | Name | Invalid Input | Expected Behavior | Duration |
|---------|------|----------------|-------------------|----------|
| 4.1 | Unknown Entity | Invalid entity IRI | Throws ConversionException | <100ms |
| 4.2 | Invalid Operator | Unknown operator | Handles gracefully or throws | <100ms |
| 4.3 | Null Org ID | null organization | Handles gracefully | <100ms |
| 4.4 | Special Characters | O'Brien name | Properly escaped SQL | <200ms |
| 4.5 | Empty WHERE | Empty Where object | Processes successfully | <200ms |

---

## Test Results Interpretation

### Successful Test Output

```
[INFO] Running org.endeavourhealth.imapi.transforms.compass.IMQtoSQLConverterTest
[INFO] Tests run: 21, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.456 s
[INFO] BUILD SUCCESS
```

### Skipped Integration Tests (Expected when DB unavailable)

```
[INFO] Tests run: 21, Failures: 0, Errors: 0, Skipped: 6, Time elapsed: 0.892 s
[INFO] BUILD SUCCESS
```

The 6 skipped tests are integration tests (3.1-3.6) - this is expected and OK when:
- Compass database is not available
- `COMPASS_DB_AVAILABLE` environment variable is not set
- Running in CI/CD pipeline without database

### Failed Test Output

```
[ERROR] FAILURES
[ERROR] Test #: testSimplePatientQueryConversion(IMQtoSQLConverterTest)
[ERROR] Expected: <sql contains SELECT>
[ERROR] Actual: null
[ERROR] ------
[INFO] BUILD FAILURE
```

---

## Test Logs & Debugging

### Enable Debug Logging

```bash
# Set log level to DEBUG
mvn test -Dorg.slf4j.simpleLogger.defaultLogLevel=DEBUG

# Or in logback.xml:
<logger name="org.endeavourhealth.imapi.transforms.compass" level="DEBUG"/>
```

### Check Generated SQL

Each test logs the generated SQL. To capture it:

```bash
mvn test -Dtest=IMQtoSQLConverterTest 2>&1 | grep "Generated SQL"
```

Example output:
```
Generated SQL: SELECT * FROM patient WHERE organization_id = 'org-123'
Generated SQL with date condition: SELECT * FROM patient WHERE organization_id = 'org-123' AND date_of_birth < '1960-01-01'
```

### Troubleshooting

#### Problem: Tests not found
```
[ERROR] No tests were executed!
```
**Solution**: Ensure test file is in correct package: `org.endeavourhealth.imapi.transforms.compass`

#### Problem: Database connection fails
```
[ERROR] java.sql.SQLException: Connection refused
```
**Solution**: Start Compass database or set `COMPASS_DB_AVAILABLE=false` to skip integration tests

#### Problem: Class not found
```
[ERROR] java.lang.ClassNotFoundException: org.endeavourhealth.imapi.transforms.compass.IMQToSQLConverter
```
**Solution**: Ensure Phase 3 implementation (`4.Converter.java`) is compiled and in classpath

#### Problem: Configuration not found
```
[WARN] Mapping configuration not found in classpath, using default
```
**Solution**: Copy `5.MappingConfiguration.yaml` to `src/main/resources/`

---

## Code Coverage

### Generate Coverage Report

```bash
mvn clean test jacoco:report
# Report generated to: target/site/jacoco/index.html
```

### Coverage Goals

| Component | Target Coverage | Current |
|-----------|-----------------|---------|
| IMQToSQLConverter | 85%+ | TBD |
| EntityResolver | 80%+ | TBD |
| ConditionTranslator | 80%+ | TBD |
| SQLGenerator | 85%+ | TBD |
| Overall | 80%+ | TBD |

---

## Continuous Integration

### GitHub Actions / GitLab CI

```yaml
# .github/workflows/test.yml
name: Test Suite
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: compass
          POSTGRES_USER: compass
          POSTGRES_PASSWORD: ''
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 21
        uses: actions/setup-java@v2
        with:
          java-version: '21'
      - name: Run tests
        env:
          COMPASS_DB_AVAILABLE: true
        run: mvn clean test
      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

---

## Performance Expectations

### Unit Test Performance

| Test Category | Count | Total Time | Per Test |
|---------------|-------|-----------|----------|
| Validation Tests | 3 | ~300ms | 100ms |
| Conversion Tests | 10 | ~2s | 200ms |
| Error Tests | 5 | ~500ms | 100ms |
| **Total** | **18** | **~2.8s** | **~150ms** |

### Integration Test Performance (with database)

| Test Category | Count | Total Time | Per Test | Notes |
|---------------|-------|-----------|----------|-------|
| DB Connection | 1 | ~500ms | 500ms | Initial connection |
| Query Tests | 5 | ~5-10s | 1-2s | Depends on data volume |
| **Total** | **6** | **~5-11s** | **~1s** | With active database |

### Combined Test Run

- **Without database**: ~3 seconds
- **With database**: ~8-15 seconds
- **With coverage**: +5-10 seconds

---

## Next Steps

1. **Run All Tests**: `mvn clean test`
2. **Check Coverage**: Open `target/site/jacoco/index.html`
3. **Fix Failures**: Debug and update implementation or tests
4. **Integrate with CI/CD**: Add test execution to pipeline
5. **Schedule Nightly**: Run integration tests with database
6. **Monitor**: Track coverage and performance metrics

---

## Reference Documentation

- **Phase 3 Implementation**: `4.Converter.java`
- **Test Data**: `5.Test.java`
- **Configuration**: `5.MappingConfiguration.yaml`
- **Architecture**: `3.Plan.md`
- **Database Schema**: `2.Compass.md`
- **Specification**: `1.Spec.md`
