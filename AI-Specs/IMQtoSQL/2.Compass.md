# Compass 2.3.0 Schema Specification for IMQ to SQL Conversion

## Overview

This document provides a comprehensive specification of the Compass 2.3.0 (Remote Subscriber Database - RSD) schema, optimized for use in IMQ (Information Model Query) to SQL conversion. It details all tables, columns, data types, relationships, and constraints necessary for translating logical health data model queries into executable SQL statements.

**Compass Version**: 2.3.0  
**Purpose**: Remote Subscriber Database for healthcare data management  
**Target Database**: Discovery Compass  

---

## Table of Contents

1. [Schema Architecture](#schema-architecture)
2. [Core Entities](#core-entities)
3. [Entity Relationships](#entity-relationships)
4. [Data Types and Mappings](#data-types-and-mappings)
5. [Key Constraints and Indexes](#key-constraints-and-indexes)
6. [Querying Patterns](#querying-patterns)

---

## Schema Architecture

### Design Principles

The Compass schema follows a dimensional healthcare data model with the following characteristics:

- **Multi-organizational**: Supports data from multiple healthcare organizations via `organization_id`
- **Patient-centric**: All clinical data is anchored to patient records
- **Person tracking**: Unique individual tracking across organizations via `person_id`
- **Temporal tracking**: Supports clinical effective dates and date precision concepts
- **Concept-based coding**: Uses both core and non-core concept references for clinical coding
- **Extensibility**: Additional data stored in `*_additional` tables (JSON, text, or concept values)

### Core Design Pattern

Most clinical tables follow this structure:
```
{
  id: bigint (primary),
  organization_id: bigint (organizational context),
  patient_id: bigint (patient within organization),
  person_id: bigint (person across organizations),
  clinical_effective_date: datetime (when recorded),
  core_concept_id: int (standardized clinical code),
  non_core_concept_id: int (source system code),
  [additional clinical fields],
  date_recorded: datetime (audit timestamp)
}
```

**Primary Key**: Composite of `(organization_id, person_id, id)` across most clinical tables

---

## Core Entities

### 1. Organization

**Purpose**: Represents healthcare organizations (GP practices, hospitals, etc.)

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique organization identifier |
| ods_code | varchar(50) | YES | Office of the Data Services code |
| name | varchar(255) | YES | Organization name |
| type_code | varchar(50) | YES | Type code (e.g., GP_PRACTICE, HOSPITAL) |
| type_desc | varchar(255) | YES | Human-readable type description |
| postcode | varchar(10) | YES | Postal code |
| parent_organization_id | bigint | YES | Parent organization reference |

**Key Indexes**: `organization_id` (PK), `fki_organization_parent_organization_id`

---

### 2. Patient

**Purpose**: Patient records within an organization; supports multiple registrations

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique patient ID within organization |
| organization_id | bigint | NO | Owning organization |
| person_id | bigint | NO | Unique person across all organizations |
| title | varchar(255) | YES | Patient title (Mr., Mrs., Dr., etc.) |
| first_names | varchar(255) | YES | Given names |
| last_name | varchar(255) | YES | Family name |
| gender_concept_id | int | YES | Gender concept reference |
| nhs_number | varchar(255) | YES | NHS number |
| date_of_birth | date | YES | Date of birth |
| date_of_death | date | YES | Date of death |
| current_address_id | bigint | YES | Current address reference |
| ethnic_code_concept_id | int | YES | Ethnicity concept reference |
| registered_practice_organization_id | bigint | YES | Registration organization |
| birth_year | smallint | YES | Birth year (denormalized) |
| birth_month | tinyint | YES | Birth month (denormalized) |
| birth_week | tinyint | YES | Birth week (denormalized) |

**Key Indexes**: `patient_id` (PK), `patient_person_id`, `patient_person_id` (PK)

**Relationships**:
- FK to `organization` (organization_id)
- FK to `patient_address` (current_address_id)
- FK to `concept` (gender_concept_id, ethnic_code_concept_id)

---

### 3. Patient Address

**Purpose**: Tracks patient addresses over time

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique address ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| address_line_1 | varchar(255) | YES | Address line 1 |
| address_line_2 | varchar(255) | YES | Address line 2 |
| address_line_3 | varchar(255) | YES | Address line 3 |
| address_line_4 | varchar(255) | YES | Address line 4 |
| city | varchar(255) | YES | City |
| postcode | varchar(10) | YES | Postcode |
| country | varchar(255) | YES | Country |
| date_from | date | YES | Date address started |
| date_to | date | YES | Date address ended |

---

### 4. Episode of Care

**Purpose**: Manages patient registration and enrollment periods

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique episode ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| registration_type_concept_id | int | YES | Type of registration (e.g., regular, temporary) |
| registration_status_concept_id | int | YES | Status (active, inactive, etc.) |
| date_registered | date | YES | Registration start date |
| date_registered_end | date | YES | Registration end date |
| usual_gp_practitioner_id | bigint | YES | Primary GP reference |

**Key Indexes**: `episode_of_care_id` (PK), `fk_episode_of_care_patient_id_organisation_id`, `episode_of_care_date_registered`, `episode_of_care_date_registered_end`

---

### 5. Encounter

**Purpose**: Individual clinical visits/consultations

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique encounter ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| practitioner_id | bigint | YES | Clinician reference |
| appointment_id | bigint | YES | Appointment reference |
| clinical_effective_date | datetime | YES | Encounter date/time |
| date_precision_concept_id | int | YES | Precision (year/month/day/minute/second/millisecond) |
| episode_of_care_id | bigint | YES | Episode of care reference |
| service_provider_organization_id | bigint | YES | Service provider organization |
| core_concept_id | int | YES | Encounter type (core concept) |
| non_core_concept_id | int | YES | Encounter type (source system code) |
| age_at_event | decimal(5,2) | YES | Patient age at encounter |
| admission_method | varchar(40) | YES | Admission method code |
| end_date | datetime | YES | Encounter end date/time |
| institution_location_id | text | YES | Location reference |
| date_recorded | datetime | YES | Record audit timestamp |

**Key Indexes**: `encounter_id` (PK), `fk_encounter_practitioner_id`, `fk_encounter_episode_of_care_id`, `encounter_patient_id`, `encounter_core_concept_id_clinical_effective_date`

---

### 6. Encounter Event

**Purpose**: Detailed event-level tracking within encounters

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique event ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | NO | Parent encounter reference |
| practitioner_id | bigint | YES | Clinician reference |
| appointment_id | bigint | YES | Appointment reference |
| clinical_effective_date | datetime | YES | Event date/time |
| date_precision_concept_id | int | YES | Date precision |
| episode_of_care_id | bigint | YES | Episode of care reference |
| service_provider_organization_id | bigint | YES | Service provider organization |
| core_concept_id | int | YES | Event type (core concept) |
| non_core_concept_id | int | YES | Event type (source system code) |
| age_at_event | decimal(5,2) | YES | Patient age at event |
| admission_method | varchar(40) | YES | Admission method |
| end_date | datetime | YES | Event end date/time |
| institution_location_id | bigint | YES | Location reference |
| date_recorded | datetime | YES | Record audit timestamp |
| finished | tinyint(1) | YES | Event completion flag |

---

### 7. Observation

**Purpose**: Clinical observations, measurements, test results, and problems

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique observation ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | YES | Encounter reference |
| practitioner_id | bigint | YES | Clinician reference |
| clinical_effective_date | datetime | YES | Clinical date |
| date_precision_concept_id | int | YES | Date precision |
| result_value | double | YES | Numeric result value |
| result_value_units | varchar(50) | YES | Unit of measurement |
| result_date | date | YES | Result date |
| result_text | text | YES | Textual result |
| result_concept_id | int | YES | Result concept reference |
| is_problem | tinyint(1) | NO | Problem flag (0/1) |
| is_review | tinyint(1) | NO | Review flag (0/1) |
| problem_end_date | date | YES | Problem resolution date |
| parent_observation_id | bigint | YES | Parent observation (e.g., systolic/diastolic under BP) |
| core_concept_id | int | YES | Observation type (core concept) |
| non_core_concept_id | int | YES | Observation type (source system code) |
| age_at_event | decimal(5,2) | YES | Patient age at observation |
| episodicity_concept_id | int | YES | Episodicity (first, review, flare) |
| is_primary | tinyint(1) | YES | Primary observation flag |
| date_recorded | datetime | YES | Record audit timestamp |

**Key Indexes**: `observation_id` (PK), `observation_patient_id`, `observation_core_concept_id`, `observation_core_concept_id_is_problem`, `observation_core_concept_id_result_value`, `ix_observation_clinical_effective_date`

---

### 8. Diagnostic Order

**Purpose**: Diagnostic tests/investigations ordered and their results

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique diagnostic order ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | YES | Encounter reference |
| practitioner_id | bigint | YES | Requesting clinician |
| clinical_effective_date | datetime | YES | Order date |
| date_precision_concept_id | int | YES | Date precision |
| result_value | double | YES | Result value |
| result_value_units | varchar(50) | YES | Result units |
| result_date | date | YES | Result date |
| result_text | text | YES | Result text |
| result_concept_id | int | YES | Result concept |
| is_problem | tinyint(1) | NO | Problem flag |
| is_review | tinyint(1) | NO | Review flag |
| problem_end_date | date | YES | Problem end date |
| parent_observation_id | bigint | YES | Parent observation |
| core_concept_id | int | YES | Test type (core concept) |
| non_core_concept_id | int | YES | Test type (source system code) |
| age_at_event | decimal(5,2) | YES | Patient age |
| episodicity_concept_id | int | YES | Episodicity |
| is_primary | tinyint(1) | YES | Primary flag |
| date_recorded | datetime | YES | Record audit timestamp |

---

### 9. Medication Statement

**Purpose**: Current and historical medication information

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique medication ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | YES | Encounter reference |
| practitioner_id | bigint | YES | Prescribing clinician |
| clinical_effective_date | datetime | YES | Medication start date |
| date_precision_concept_id | int | YES | Date precision |
| cancellation_date | date | YES | Cancellation date |
| dose | varchar(1000) | YES | Dose description |
| quantity_value | double | YES | Quantity prescribed |
| quantity_unit | varchar(255) | YES | Quantity unit |
| authorisation_type_concept_id | int | YES | Authorization type |
| core_concept_id | int | YES | Medication (core concept) |
| non_core_concept_id | int | YES | Medication (source system code) |
| bnf_reference | varchar(6) | YES | BNF dictionary reference |
| age_at_event | decimal(5,2) | YES | Patient age |
| issue_method | text | YES | Issue method (handwritten, printed, etc.) |
| date_recorded | datetime | YES | Record audit timestamp |

---

### 10. Medication Order

**Purpose**: Individual medication prescriptions (related to Medication Statements)

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique order ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | YES | Encounter reference |
| practitioner_id | bigint | YES | Prescribing clinician |
| clinical_effective_date | datetime | YES | Prescription date |
| date_precision_concept_id | int | YES | Date precision |
| dose | varchar(1000) | YES | Dose description |
| quantity_value | double | YES | Quantity prescribed |
| quantity_unit | varchar(255) | YES | Quantity unit |
| duration_days | int | YES | Duration in days |
| estimated_cost | double | YES | Estimated cost |
| medication_statement_id | bigint | YES | Parent statement reference |
| core_concept_id | int | YES | Medication (core concept) |
| non_core_concept_id | int | YES | Medication (source system code) |
| bnf_reference | varchar(6) | YES | BNF dictionary reference |
| age_at_event | decimal(5,2) | YES | Patient age |
| issue_method | text | YES | Issue method |
| date_recorded | datetime | YES | Record audit timestamp |

---

### 11. Allergy/Intolerance

**Purpose**: Patient allergies and intolerances

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique allergy ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| encounter_id | bigint | YES | Encounter reference |
| practitioner_id | bigint | YES | Recording clinician |
| clinical_effective_date | datetime | YES | Allergy date |
| date_precision_concept_id | int | YES | Date precision |
| is_review | tinyint(1) | NO | Review flag |
| core_concept_id | int | YES | Allergy type (core concept) |
| non_core_concept_id | int | YES | Allergy type (source system code) |
| age_at_event | decimal(5,2) | YES | Patient age |
| date_recorded | datetime | YES | Record audit timestamp |

---

### 12. Appointment

**Purpose**: Scheduled appointments

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique appointment ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| practitioner_id | bigint | YES | Scheduled clinician |
| schedule_id | bigint | YES | Schedule reference |
| start_date | datetime | YES | Appointment start |
| planned_duration | int | YES | Planned duration (minutes) |
| actual_duration | int | YES | Actual duration (minutes) |
| appointment_status_concept_id | int | YES | Status (arrived, DNA, etc.) |
| patient_wait | int | YES | Wait time (minutes) |
| patient_delay | int | YES | Patient delay (minutes) |
| date_time_sent_in | datetime | YES | Time patient seen |
| date_time_left | datetime | YES | Time patient left |
| source_id | varchar(36) | YES | External system ID |
| cancelled_date | datetime | YES | Cancellation date |

---

### 13. Flag

**Purpose**: Patient alerts/warnings

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique flag ID |
| organization_id | bigint | NO | Owning organization |
| patient_id | bigint | NO | Patient reference |
| person_id | bigint | NO | Person reference |
| effective_date | datetime | YES | Flag effective date |
| date_precision_concept_id | int | YES | Date precision |
| is_active | tinyint(1) | NO | Active status flag |
| flag_text | text | YES | Warning text |

---

### 14. Location

**Purpose**: Healthcare facilities and practice locations

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique location ID |
| name | varchar(255) | YES | Location name |
| type_code | varchar(50) | YES | Location type code |
| type_desc | varchar(255) | YES | Location type description |
| postcode | varchar(10) | YES | Postcode |
| managing_organization_id | bigint | YES | Managing organization reference |

---

### 15. Practitioner

**Purpose**: Healthcare professionals (clinicians)

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| id | bigint | NO | Unique practitioner ID |
| [standard demographic fields] | ... | ... | Clinician information |

---

### 16. Concept

**Purpose**: Clinical coding system mapping (SNOMED, Read, CTV3, ICD-10, OPCS4, etc.)

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| dbid | int | NO | Unique concept database ID |
| document | int | YES | Document reference |
| id | varchar(150) | YES | Human-readable concept ID |
| draft | tinyint(1) | YES | Draft status |
| name | varchar(255) | YES | Short name |
| description | varchar(400) | YES | Full description |
| scheme | bigint | YES | Coding scheme (Read, CTV3, SNOMED, etc.) |
| code | varchar(40) | YES | Coding scheme code |
| use_count | bigint | YES | Usage frequency |
| updated | datetime | NO | Last update timestamp |

**Key Indexes**: `ix_scheme_code`, `ix_code`, `ix_dbid_code`

---

### 17. Concept Map

**Purpose**: Maps between legacy and core coding systems

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| legacy | int | NO | Legacy concept ID |
| core | int | NO | Core concept ID |
| updated | datetime | NO | Last update timestamp |
| id | int | NO | Unique map ID |
| deleted | tinyint(1) | YES | Deletion flag |

**Key Indexes**: `concept_map_uq` (legacy, deleted, updated), `ix_legacy_core`

---

## Entity Relationships

### Primary Relationships

```
Organization (1) ──→ (N) Patient
Organization (1) ──→ (N) Episode of Care
Organization (1) ──→ (N) Encounter
Organization (1) ──→ (N) Observation
Organization (1) ──→ (N) Medication Statement
Organization (1) ──→ (N) Appointment
Organization (1) ──→ (N) Allergy/Intolerance
Organization (1) ──→ (N) Flag
Organization (1) ──→ (N) Location

Patient (1) ──→ (N) Episode of Care
Patient (1) ──→ (N) Encounter
Patient (1) ──→ (N) Observation
Patient (1) ──→ (N) Medication Statement
Patient (1) ──→ (N) Appointment
Patient (1) ──→ (N) Allergy/Intolerance
Patient (1) ──→ (N) Flag
Patient (1) ──→ (N) Patient Address

Episode of Care (1) ──→ (N) Encounter
Episode of Care (1) ──→ (N) Encounter Event

Encounter (1) ──→ (N) Observation
Encounter (1) ──→ (N) Medication Statement
Encounter (1) ──→ (N) Diagnostic Order
Encounter (1) ──→ (N) Appointment

Medication Statement (1) ──→ (N) Medication Order

Concept (1) ──→ (N) [all tables with core_concept_id, non_core_concept_id, etc.]
Practitioner (1) ──→ (N) Encounter
Practitioner (1) ──→ (N) Observation
Location (1) ──→ (N) Encounter
```

### Multi-organizational Person Tracking

- **person_id**: Unique identifier for an individual across ALL organizations
- **patient_id**: Local patient record within a specific organization
- **organization_id + patient_id**: Unique within organization
- **organization_id + person_id + id**: Composite primary key for most clinical tables

---

## Data Types and Mappings

### SQL Data Types Used

| Data Type | Size | Use Cases |
|-----------|------|-----------|
| `bigint` | 8 bytes | IDs, large identifiers, foreign keys |
| `int` | 4 bytes | Concept IDs, small integers |
| `tinyint(1)` | 1 byte | Boolean flags (0/1), status codes |
| `smallint` | 2 bytes | Birth year, small integer values |
| `double` | 8 bytes | Numeric results, measurements |
| `decimal(5,2)` | Variable | Age values (max 999.99), precise decimals |
| `datetime` | 8 bytes | Clinical dates with time precision |
| `date` | 3 bytes | Dates without time |
| `varchar(N)` | Variable | Text fields (up to N characters) |
| `text` | Variable | Large text fields (unlimited) |
| `json` | Variable | Unstructured data (JSON format) |

### Date Precision Levels

Values in `date_precision_concept_id` indicate granularity:
- **1**: Year only
- **2**: Year and month
- **5**: Year, month, and day
- **12**: Minute precision
- **13**: Second precision
- **14**: Millisecond precision

---

## Key Constraints and Indexes

### Primary Key Pattern

Most clinical tables use a composite primary key:
```sql
PRIMARY KEY (organization_id, person_id, id)
```

Benefits:
- Ensures uniqueness across multi-organizational environment
- Optimizes queries filtered by organization and person
- Supports partitioning strategies

### Common Indexes

**Clinical Date Indexes**:
- `clinical_effective_date`: Enables date range filtering
- `date_registered`: For episode of care queries
- `encounter_core_concept_id_clinical_effective_date`: Combined type + date queries

**Patient Identification**:
- `patient_id`: Patient-specific queries
- `person_id`: Cross-organizational queries
- `fk_patient_id_organization_id`: Organization-patient combinations

**Concept Mapping**:
- `core_concept_id`: Concept-based filtering
- `non_core_concept_id`: Source system code filtering
- `ix_scheme_code`: Concept lookup by scheme and code

**Relationship Indexes**:
- `encounter_id`, `practitioner_id`, `episode_of_care_id`, etc.

---

## Querying Patterns

### Common Query Patterns for IMQ to SQL Conversion

#### 1. Patient Demographics Query
```sql
SELECT p.id, p.first_names, p.last_name, p.date_of_birth, p.gender_concept_id
FROM patient p
WHERE p.organization_id = ?
  AND p.person_id = ?
```

#### 2. Recent Observations for Condition
```sql
SELECT o.id, o.clinical_effective_date, o.result_value, o.result_value_units, o.result_text
FROM observation o
WHERE o.organization_id = ?
  AND o.patient_id = ?
  AND o.core_concept_id = ?
  AND o.clinical_effective_date >= DATE_SUB(NOW(), INTERVAL 6 MONTH)
ORDER BY o.clinical_effective_date DESC
```

#### 3. Active Medications
```sql
SELECT ms.id, ms.core_concept_id, ms.dose, ms.quantity_value, ms.quantity_unit
FROM medication_statement ms
WHERE ms.organization_id = ?
  AND ms.patient_id = ?
  AND ms.cancellation_date IS NULL
  AND ms.clinical_effective_date <= NOW()
ORDER BY ms.clinical_effective_date DESC
```

#### 4. Encounters with Concept Filtering
```sql
SELECT e.id, e.clinical_effective_date, e.core_concept_id, p.first_names, p.last_name
FROM encounter e
JOIN patient p ON e.patient_id = p.id AND e.organization_id = p.organization_id
WHERE e.organization_id = ?
  AND e.patient_id = ?
  AND e.core_concept_id IN (?, ?, ?)
ORDER BY e.clinical_effective_date DESC
```

#### 5. Allergy Check
```sql
SELECT a.id, a.core_concept_id, c.description
FROM allergy_intolerance a
LEFT JOIN concept c ON a.core_concept_id = c.dbid
WHERE a.organization_id = ?
  AND a.patient_id = ?
```

#### 6. Multi-organizational Person Query
```sql
SELECT p.id, p.organization_id, p.first_names, p.last_name
FROM patient p
WHERE p.person_id = ?
ORDER BY p.organization_id
```

### Filtering and Aggregation

#### Time-based Filtering
- Use `clinical_effective_date` for when data was recorded
- Use `date_precision_concept_id` to determine precision handling
- Use date arithmetic: `DATE_ADD()`, `DATE_SUB()`, `DATEDIFF()`

#### Concept-based Filtering
- Primary lookup: `core_concept_id` (standardized coding)
- Fallback: `non_core_concept_id` (source system codes)
- Join with `concept` table for descriptions

#### Problem/Status Filtering
- `is_problem = 1`: Active problems/issues
- `is_review = 1`: Review/follow-up records
- `is_active = 1`: Active flags
- `cancellation_date IS NULL`: Current/active records

### Aggregation Patterns

#### Count Recent Observations
```sql
SELECT COUNT(*) as observation_count, AVG(result_value) as avg_value
FROM observation
WHERE organization_id = ? AND patient_id = ? AND core_concept_id = ?
  AND clinical_effective_date >= DATE_SUB(NOW(), INTERVAL 1 YEAR)
```

#### Encounter Statistics
```sql
SELECT core_concept_id, COUNT(*) as encounter_count, MAX(clinical_effective_date) as last_encounter
FROM encounter
WHERE organization_id = ? AND patient_id = ?
GROUP BY core_concept_id
```

---

## IMQ to SQL Conversion Rules

### Basic Rules

1. **Patient Context**: All queries MUST include `organization_id` and `patient_id` filters
2. **Temporal Context**: Use `clinical_effective_date` for data recorded
3. **Concept Mapping**: Map IMQ concepts to Compass `core_concept_id` values
4. **Null Handling**: Most optional fields are `DEFAULT NULL`
5. **Flags**: Boolean flags stored as `tinyint(1)` (0 or 1)

### Advanced Patterns

1. **Additional Data Lookup**: Use `*_additional` tables for property extensions
2. **Hierarchical Concepts**: Use `parent_observation_id` for related observations
3. **Date Precision**: Apply precision filtering before temporal operations
4. **Concept Chains**: Use `concept_map` for legacy to core system mapping

---

## Summary

The Compass 2.3.0 schema provides a comprehensive data model for healthcare information management with:

- **Patient-centric design** supporting multi-organizational environments
- **Rich clinical data** including observations, medications, encounters, and allergies
- **Standardized coding** through concept mapping
- **Temporal tracking** with date precision support
- **Extensible architecture** through additional data tables
- **Optimized indexes** for common query patterns

This specification enables the IMQ to SQL converter to translate logical health data queries into efficient, organization-aware SQL statements against the Compass database.