# Phase 4 Quick Start Guide - QOF to IMQ Converter

This guide shows how to use the Phase 4 QOF-to-IMQ code generator to transform QOF specifications into IMQuery format.

---

## Quick Start

### Option 1: Programmatic Usage (Java API)

```java
import org.endeavourhealth.imapi.transformation.engine.QOFToIMQTransformer;
import org.endeavourhealth.imapi.model.imq.Query;

// Create transformer
QOFToIMQTransformer transformer = new QOFToIMQTransformer();

// Transform from file
try {
    Query imQuery = transformer.transformFromFile("path/to/QOF-Diabetes.json");
    System.out.println("Transformation successful!");
    System.out.println("Query IRI: " + imQuery.getIri());
} catch (Exception e) {
    System.err.println("Transformation failed: " + e.getMessage());
}
```

### Option 2: Command-Line Interface

```bash
# Basic transformation
java org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input QOF-Diabetes.json \
  --output IMQuery-output.json

# With configuration file
java org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input QOF-Diabetes.json \
  --output IMQuery-output.json \
  --config transformation.yaml

# Batch processing
java org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input-dir /path/to/qof/files \
  --output-dir /path/to/output \
  --config transformation.yaml
```

---

## Input Format

### QOF JSON Structure

The transformer expects QOF documents in this format:

```json
{
  "name": "Diabetes_v49.0",
  "selections": [
    {
      "name": "GMS registration status",
      "rules": [
        {
          "logic": "If REG_DAT ≠ Null AND If DEREG_DAT = Null",
          "ifTrue": "Select",
          "ifFalse": "Reject",
          "description": "Select registered patients..."
        }
      ]
    }
  ],
  "registers": [
    {
      "name": "DM_REG",
      "description": "Diabetes register",
      "base": "GMS registration status",
      "rules": [
        {
          "rule": 1,
          "logic": "If DMLAT_DAT ≠ Null AND If DMRES_DAT = Null",
          "ifTrue": "Next rule",
          "ifFalse": "Reject",
          "description": "..."
        },
        {
          "rule": 2,
          "logic": "If PAT_AGE < 17 years",
          "ifTrue": "Reject",
          "ifFalse": "Select",
          "description": "..."
        }
      ]
    }
  ],
  "extractionFields": [
    {
      "field": 1,
      "name": "PAT_ID",
      "cluster": "n/a",
      "logic": "Unconditional",
      "description": "Patient ID"
    }
  ],
  "indicators": [
    {
      "name": "DM006",
      "description": "Patients with nephropathy",
      "base": "DM_REG",
      "rules": [
        {
          "rule": 1,
          "logic": "If PRT_DAT = Null AND If MAL_DAT = Null",
          "ifTrue": "Reject",
          "ifFalse": "Next rule",
          "description": "..."
        }
      ]
    }
  ]
}
```

---

## Output Format

The transformer generates IMQuery documents in this format:

```json
{
  "iri": "http://endhealth.info/qof#gms-registration-status",
  "name": "GMS registration status",
  "description": "Select registered patients...",
  "typeOf": {
    "iri": "http://endhealth.info/im#Patient"
  },
  "rule": [
    {
      "ifTrue": "SELECT",
      "ifFalse": "REJECT",
      "where": {
        "and": [
          {
            "iri": "http://endhealth.info/im#registrationDate",
            "operator": "!=",
            "value": null
          },
          {
            "iri": "http://endhealth.info/im#deregistrationDate",
            "operator": "=",
            "value": null
          }
        ]
      }
    }
  ]
}
```

---

## Supported Logic Patterns

The transformer automatically converts these QOF logic patterns:

### 1. Null Checks
```
QOF:    If REG_DAT ≠ Null
IMQuery: {"iri": "..#registrationDate", "operator": "!=", "value": null}
```

### 2. Comparisons
```
QOF:    If PAT_AGE < 17 years
IMQuery: {"iri": "..#age", "operator": "<", "value": "17", "units": {...}}
```

### 3. Date Comparisons
```
QOF:    If REG_DAT <= ACHV_DAT
IMQuery: {"iri": "..#registrationDate", "operator": "<=", "relativeTo": {"parameter": "$achievementDate"}}
```

### 4. Date Arithmetic
```
QOF:    If ACE_DAT > (PPED – 6 months)
IMQuery: {"iri": "..#aceInhibitorDate", "operator": ">", "relativeTo": {"parameter": "$paymentPeriodEnd", "offset": -6, "unit": "months"}}
```

### 5. AND Conditions
```
QOF:    (If A ≠ Null AND If B = Null)
IMQuery: {"and": [
  {"iri": "..#fieldA", "operator": "!=", "value": null},
  {"iri": "..#fieldB", "operator": "=", "value": null}
]}
```

### 6. OR Conditions
```
QOF:    (If A ≠ Null) OR (If B = Null)
IMQuery: {"or": [
  {"iri": "..#fieldA", "operator": "!=", "value": null},
  {"iri": "..#fieldB", "operator": "=", "value": null}
]}
```

---

## Error Handling

The transformer provides detailed error messages:

```
Pre-Conversion Errors:
  - Missing required QOF properties
  - Invalid rule definitions
  - Broken references between components

Parsing Errors:
  - Unrecognized logic patterns
  - Invalid field references
  - Malformed date arithmetic

Output Errors:
  - Invalid IMQuery structure
  - Missing required fields
  - Type constraint violations
```

### Example Error Message:
```
[ERROR] Transformation failed: Reference integrity check failed
  Register 'DM_REG' references base Selection 'GMS registration status' which does not exist
  Location: registers[0].base
  Suggestion: Add the Selection or correct the base reference name
```

---

## Configuration

Create a `transformation.yaml` file to customize behavior:

```yaml
# Field Mapping
fieldMappings:
  REG_DAT: http://endhealth.info/im#registrationDate
  DEREG_DAT: http://endhealth.info/im#deregistrationDate
  PAT_AGE: http://endhealth.info/im#age
  DMLAT_DAT: http://endhealth.info/im#latestDiabetesDiagnosisDate
  DMRES_DAT: http://endhealth.info/im#latestDiabetesResolvedDate

# Output Options
output:
  format: organized  # or "array"
  prettyPrint: true
  includeMetadata: true

# IRI Configuration
iri:
  namespace: http://endhealth.info/qof#
  slugify: true

# Temporal Parameters
temporal:
  achievementDate: $achievementDate
  paymentPeriodEnd: $paymentPeriodEnd
  searchDate: $searchDate
```

---

## File Locations

**Source Code:**
- Main transformer: `src/main/java/org/endeavourhealth/imapi/transformation/engine/QOFToIMQTransformer.java`
- CLI entry point: `src/main/java/org/endeavourhealth/imapi/transformation/cli/QOFToIMQCliApplication.java`
- Component builders: `src/main/java/org/endeavourhealth/imapi/transformation/component/`
- Output handlers: `src/main/java/org/endeavourhealth/imapi/transformation/output/`

**Example Data:**
- QOF-Diabetes.json: `AI-Specs/QOFtoIMQ/QOF-Diabetes.json`
- Specifications: `AI-Specs/QOFtoIMQ/`

**Configuration:**
- Example config: `artifacts/config-examples/`

---

## Troubleshooting

### Issue: "Reference not found"
**Solution:** Verify that all `base` references in registers and indicators point to existing selections or registers.

### Issue: "Unrecognized field reference"
**Solution:** Check that field names in logic expressions match exactly (case-sensitive) and exist in the configuration field mapping.

### Issue: "Invalid date arithmetic"
**Solution:** Ensure date arithmetic follows the pattern `FIELD OP (PARAM ± N unit)`, e.g., `(PPED – 6 months)`

### Issue: "File write failed"
**Solution:** Check output directory permissions and use `overwrite: BACKUP` strategy to avoid conflicts.

---

## Example Execution

```bash
# Transform a single QOF file
java -cp imapi.jar org.endeavourhealth.imapi.transformation.cli.QOFToIMQCliApplication \
  --input QOF-Diabetes.json \
  --output IMQuery-Diabetes.json

# Expected output:
# [INFO] Loaded QOF document: Diabetes_v49.0
# [INFO] Validating QOF structure...
# [INFO] Transforming 1 selection
# [INFO] Transforming 1 register
# [INFO] Transforming 0 indicators
# [INFO] Validation complete
# [INFO] Writing output to IMQuery-Diabetes.json
# [SUCCESS] Transformation complete in 245ms
```

---

## Advanced Usage

### Batch Processing with Progress

```java
import org.endeavourhealth.imapi.transformation.batch.*;

BatchTransformationProcessor processor = new BatchTransformationProcessor();
processor.setProgressListener(new ConsoleProgressListener());
BatchTransformationReport report = processor.processBatch(
    "input-directory",
    "output-directory",
    "config.yaml"
);

System.out.println("Processed: " + report.getProcessedCount());
System.out.println("Errors: " + report.getErrorCount());
```

### Custom Validation

```java
QueryOutputValidator validator = new QueryOutputValidator();
ValidationResult result = validator.validate(imQuery);

if (!result.isValid()) {
    System.out.println(result.getReport());
    for (ValidationError error : result.getErrors()) {
        System.out.println("Field: " + error.getField() + " - " + error.getMessage());
    }
}
```

---

## Next Steps

1. **Run Tests** - Execute unit and integration tests to verify functionality
2. **Try Examples** - Transform the QOF-Diabetes.json example file
3. **Custom Data** - Adapt the converter for your own QOF specifications
4. **Integration** - Embed the transformer in your application
5. **Monitoring** - Set up logging and error reporting for production use

---

## Support

For issues or questions:
1. Check the QOF-To-IMQ-Specification.md for detailed conversion rules
2. Review the error messages and troubleshooting section above
3. Check the test files for working examples
4. Consult the Phase 4 Execution Summary for architectural details
